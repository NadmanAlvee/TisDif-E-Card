<%- include('./partials/header.ejs') %>
<link rel="stylesheet" href="/css/trackOrder.css" />

<div class="container">
	<h3>
		Track Orders
		<img
			src="https://img.icons8.com/ios-glyphs/40/search--v1.png"
			alt="Search"
		/>
	</h3>
	<!-- Search bar -->
	<div class="orderSearch" id="orderSearch">
		<div class="search_wrapper">
			<form>
				<input
					name="orderQuery"
					type="text"
					spellcheck="false"
					placeholder="Search Order id"
					required
				/>
			</form>
		</div>
	</div>

	<% if(order != null){ %>
		<div class="order-card">
			<div class="order-header">
				<div>
					<p class="order-id"><strong>Order ID:</strong> <%= order._id %></p>
				</div>
				<div class="order-status <%= order.status.toLowerCase() %>">
					<%= order.status %>
				</div>
			</div>
			<div class="order-details">
				<div class="items-list">
					<% order.items.forEach((item, index) => { %>
					<div class="item-card">
						<% if (item.product && item.product.image) { %>
						<img
							src="<%= item.product.image[0] %>"
							alt="<%= item.product.name %>"
							class="product-image"
						/>
						<% } %>
						<div class="item-info">
							<h4><%= item.product?.name || 'Product not found' %></h4>
							<p>Quantity: <%= item.quantity %></p>
							<p>Price per unit: <%= item.price.toFixed(2) %> BDT</p>
							<% if (order.status.toLowerCase() === 'pending') { %>
							<div class="summary-cancel">
								<form
									action="/order/<%= order._id %>/items/<%= item._id %>/delete"
									method="POST"
								>
									<button class="cancelBtn">Cancel Item</button>
								</form>
							</div>
							<% if (errors && errors.common) { %>
							<p class="error show"><%= errors.common.msg %></p>
							<% } %> <% } %>
						</div>
					</div>
					<% }) %>
				</div>

				<div class="order-summary">
					<div class="summary-item">
						<span>Total Amount:</span>
						<span><%= order.totalAmount.toFixed(2) %> BDT</span>
					</div>
					<div class="summary-item">
						<span>Payment Method:</span>
						<span><%= order.paymentMethod.replace(/,/g, '') %></span>
					</div>
					<div class="summary-item">
						<span>Delivery Method:</span>
						<span><%= order.deliveryMethod.replace(/,/g, '') %></span>
					</div>
				</div>
			</div>
		</div>
	<% } %>

</div>

<script>
	document.addEventListener("DOMContentLoaded", ()=>{
		const searchForm = document.querySelector("#orderSearch form");
		searchForm.addEventListener("submit", (event)=>{
			event.preventDefault();

			const orderInput = searchForm.querySelector("input[name='orderQuery']");
			const orderQuery = orderInput.value.trim();

			fetch("/trackOrder", {
				method: "POST",
				headers: {
					"Content-Type": "application/json",
					"Accept": "application/json",
				},
				body: JSON.stringify({ orderQuery })
			})
			.then(response => {
				window.location.href = `/trackOrder/${orderQuery}`
			})
			.catch(err => {

			})
		})
	})
</script>
<%- include('./partials/footer.ejs') %>